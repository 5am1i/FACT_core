{% extends "base.html" %}

{% set active_page = "Info" %}

{% block head %}
    <meta http-equiv="refresh" content="20" />
{% endblock %}

{% macro mem_label(component) %}
    {{ component['system']['memory_used'] | number_format }} / {{ component['system']['memory_total'] | number_format }}
{% endmacro %}

{% macro disk_label(component) %}
    {{ component['system']['disk_used'] | number_format }} / {{ component['system']['disk_total'] | number_format }}
{% endmacro %}

{% macro component_card(component) %}
    <div class="card m-3">
        <div class="card-body">
            <h5 class="card-title">{{ component['name'] }} status</h5>
            <h6 class="card-subtitle mb-2 {% if component['status'] == 'offline'%}text-danger{% else %}text-success{% endif %}">
                {{ component['status'] }}
            </h6>
            <table class="table table-borderless mb-0">
                <tr>
                    <td class="align-middle text-center" style="width: 30px;"><i class="fab fa-linux"></i></td>
                    <td>{{ component['platform']['os'] }}</td>
                    <td class="align-middle text-center"><i class="fab fa-python"></i></td>
                    <td>{{ component['platform']['python'] }}</td>
                    <td class="align-middle text-center"><i class="fas fa-code-branch"></i></td>
                    <td>{{ component['platform']['fact_version'] }}</td>
                </tr>
                <tr>
                    <td class="align-middle text-center"><i class="fas fa-microchip"></i></td>
                    <td colspan="5">{{ component['system']['cpu_cores'] }} cores ({{ component['system']['virtual_cpu_cores'] }} threads) @ {{ component['system']['cpu_freq'] | nice_number}} MHz</td>
                </tr>
                <tr>
                    <td class="align-middle text-center"><i class="fas fa-memory"></i></td>
                    <td colspan="5" class="align-middle">
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar text-center {% if component['system']['memory_percent'] > 80.0 %}bg-warning{% endif %}" role="progressbar" style="width: {{ component['system']['memory_percent'] }}%">
                                {% if component['system']['memory_percent'] >= 50.0 %}{{ mem_label(component) }}{% endif %}
                            </div>
                            &nbsp;&nbsp;{% if component['system']['memory_percent'] < 50.0 %}{{ mem_label(component) }}{% endif %}
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="align-middle text-center"><i class="fas fa-hdd"></i></td>
                    <td colspan="5" class="align-middle">
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar text-center {% if component['system']['disk_percent'] > 80.0 %}bg-warning{% endif %}" role="progressbar" style="width: {{ component['system']['disk_percent'] }}%">
                                {% if component['system']['disk_percent'] >= 50.0 %}{{ disk_label(component) }}{% endif %}
                            </div>
                            &nbsp;&nbsp;{% if component['system']['disk_percent'] < 50.0 %}{{ disk_label(component) }}{% endif %}
                        </div>
                    </td>
                </tr>
            </table>
       </div>
    </div>
{% endmacro %}

{% macro plugin_card(plugin_name, plugin_data) %}
    {% set description, _, __, version, dependencies, blacklist, whitelist, threads = analysis_plugin_info[plugin_name] %}
    <div class="card m-3" style="width: 400px;">
        <div class="card-body">
            <h5 class="card-title">{{ plugin_name }}</h5>
            <h6 class="card-subtitle mb-2 text-muted">{{ version }}</h6>
            <table class="table table-borderless">
                <tr>
                    <td style="width: 30px;">
                        <i class="fas fa-align-justify"></i>
                    </td>
                    <td style="width: 46px;">{{ threads }}</td>
                    <td style="width: 30px;">
                        {% set span_class = " fa-spin" if plugin_data['active'] else "" %}
                        {% set span_style = "color: green" if plugin_data['active'] else "color: darkgrey" %}
                        {% set span_style = "color: yellow" if plugin_data.queue > 150 else span_style %}
                        <i class="fas fa-cog{{ span_class }}" style="{{ span_style }}"></i>
                    </td>
                    <td style="width: 46px; {{ span_style }}">
                        {{ plugin_data.active | nice_number }}
                    </td>
                    <td style="width: 30px;">
                        {% set span_style = "color: black" if plugin_data['queue'] else "color: darkgrey" %}
                        <i class="fas fa-sign-in-alt" style="{{ span_style }}"></i>
                    </td>
                    <td style="{{ span_style }}">
                        {{ plugin_data.queue | nice_number }}
                    </td>
                </tr>
            </table>

            <button class="btn btn-outline-secondary btn-block" data-toggle="collapse" data-target="#{{ plugin_name }}">
                <i class="fas fa-caret-down"></i>
            </button>

            <div class="collapse m-0 p-0 mt-3" id="{{ plugin_name }}">
                <span class="card-text">
                    {{ description }}
                </span>
                <table class="table table-borderless mb-0">
                    <tr>
                        <td style="width: 30px;" class="align-middle"><i class="fas fa-project-diagram"></i></td>
                        <td>{{ dependencies | list_group_collapse | safe}}</td>
                    </tr>
                    <tr>
                        <td class="align-middle"><i class="fas fa-flag"></i></td>
                        <td>{{ blacklist | list_group_collapse | safe }}</td>
                    </tr>
                    <tr>
                        <td class="align-middle"><i class="far fa-flag"></i></td>
                        <td>{{ whitelist | list_group_collapse | safe }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
{% endmacro %}



{% block body %}

<div class="row justify-content-center mt-4">
    {% for component in status %}
        {% if component and component['platform'] and component['system'] %}
            {{ component_card(component) }}
		{% endif %}
	{% endfor %}
</div>

{% for component in status %}
    {% if component and component['analysis'] %}
        <div class="row justify-content-center">
            <div class="card m-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">general queues</h5>
                    <table class="table table-borderless mb-0">
                        {% set unpacking_class = "table-warning" if component['unpacking']['unpacking_queue'] > 500 else "" %}
                        <tr class="{{ unpacking_class }}">
                            <td class="px-0">Pending extraction</td>
                            <td class="px-0" style="text-align: right; width: 80px;">{{ component['unpacking']['unpacking_queue'] | nice_number }}</td>
                        </tr>
                        {% set analysis_main_class = "table-warning" if component['analysis']['analysis_main_scheduler'] > 150 else "" %}
                        <tr class="{{ analysis_main_class }}">
                            <td class="px-0">Unscheduled analysis</td>
                            <td class="px-0" style="text-align: right;">{{ component['analysis']['analysis_main_scheduler'] | nice_number }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
{% endfor %}

{% for component in status %}
    {% if component and component['analysis'] %}
        <div class="row justify-content-center">
            {% for plugin_name, plugin_data in component['analysis']['plugins'].items() | sort %}
                {% if "dummy" not in plugin_name %}  {# {% if plugin != "analysis_main_scheduler" %} #}
                    {{ plugin_card(plugin_name, plugin_data) }}
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}
{% endfor %}

{% endblock %}
